# GitHub Actions Workflow for Infrastructure Deployment
name: Infrastructure Deployment

on:
  push:
    branches: [ main ]
    paths:
      - 'infrastructure/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'infrastructure/**'
  workflow_dispatch:

env:
  TERRAFORM_VERSION: '1.5.0'
  WORKING_DIRECTORY: './infrastructure'
  BACKEND_RESOURCE_GROUP_NAME: 'rg-terraform-state'
  BACKEND_STORAGE_ACCOUNT_NAME: 'tfstateakscrud${{ github.run_number }}'
  BACKEND_CONTAINER_NAME: 'tfstate'
  BACKEND_KEY: 'aks-crud-app.tfstate'

jobs:
  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    outputs:
      tfplanExitCode: ${{ steps.tf-plan.outputs.exitcode }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TERRAFORM_VERSION }}

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Setup Terraform Backend
      run: |
        # Create resource group for Terraform state
        az group create --name ${{ env.BACKEND_RESOURCE_GROUP_NAME }} --location "East US 2"
        
        # Create storage account
        az storage account create \
          --resource-group ${{ env.BACKEND_RESOURCE_GROUP_NAME }} \
          --name ${{ env.BACKEND_STORAGE_ACCOUNT_NAME }} \
          --sku Standard_LRS \
          --encryption-services blob
        
        # Create container
        az storage container create \
          --name ${{ env.BACKEND_CONTAINER_NAME }} \
          --account-name ${{ env.BACKEND_STORAGE_ACCOUNT_NAME }}

    - name: Terraform Init
      working-directory: ${{ env.WORKING_DIRECTORY }}
      env:
        ARM_CLIENT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
        ARM_CLIENT_SECRET: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}
        ARM_SUBSCRIPTION_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}
        ARM_TENANT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}
      run: |
        terraform init \
          -backend-config="resource_group_name=${{ env.BACKEND_RESOURCE_GROUP_NAME }}" \
          -backend-config="storage_account_name=${{ env.BACKEND_STORAGE_ACCOUNT_NAME }}" \
          -backend-config="container_name=${{ env.BACKEND_CONTAINER_NAME }}" \
          -backend-config="key=${{ env.BACKEND_KEY }}"

    - name: Terraform Format Check
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: |
        echo "Checking Terraform files in $(pwd)"
        ls -la
        terraform fmt -check -diff

    - name: Terraform Validate
      working-directory: ${{ env.WORKING_DIRECTORY }}
      env:
        ARM_CLIENT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
        ARM_CLIENT_SECRET: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}
        ARM_SUBSCRIPTION_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}
        ARM_TENANT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}
      run: terraform validate

    - name: Terraform Plan
      id: tf-plan
      working-directory: ${{ env.WORKING_DIRECTORY }}
      env:
        ARM_CLIENT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
        ARM_CLIENT_SECRET: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}
        ARM_SUBSCRIPTION_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}
        ARM_TENANT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}
      run: |
        export exitcode=0
        terraform plan -detailed-exitcode -no-color -out tfplan || export exitcode=$?
        
        echo "exitcode=$exitcode" >> $GITHUB_OUTPUT
        
        if [ $exitcode -eq 1 ]; then
          echo Terraform Plan Failed!
          exit 1
        else 
          exit 0
        fi

    - name: Publish Terraform Plan
      uses: actions/upload-artifact@v4
      with:
        name: tfplan
        path: ${{ env.WORKING_DIRECTORY }}/tfplan

    - name: Create String Output
      id: tf-plan-string
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: |
        TERRAFORM_PLAN=$(terraform show -no-color tfplan)
        
        delimiter="$(openssl rand -hex 8)"
        echo "summary<<${delimiter}" >> $GITHUB_OUTPUT
        echo "## Terraform Plan Output" >> $GITHUB_OUTPUT
        echo "<details><summary>Click to expand</summary>" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo '```terraform' >> $GITHUB_OUTPUT
        echo "$TERRAFORM_PLAN" >> $GITHUB_OUTPUT
        echo '```' >> $GITHUB_OUTPUT
        echo "</details>" >> $GITHUB_OUTPUT
        echo "${delimiter}" >> $GITHUB_OUTPUT

    - name: Publish Terraform Plan to Task Summary
      env:
        SUMMARY: ${{ steps.tf-plan-string.outputs.summary }}
      run: |
        echo "$SUMMARY" >> $GITHUB_STEP_SUMMARY

  terraform-apply:
    name: Terraform Apply
    if: github.ref == 'refs/heads/main' && needs.terraform-plan.outputs.tfplanExitCode == 2
    runs-on: ubuntu-latest
    environment: production
    needs: [terraform-plan]
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TERRAFORM_VERSION }}

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Download Terraform Plan
      uses: actions/download-artifact@v4
      with:
        name: tfplan
        path: ${{ env.WORKING_DIRECTORY }}

    - name: Terraform Init
      working-directory: ${{ env.WORKING_DIRECTORY }}
      env:
        ARM_CLIENT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
        ARM_CLIENT_SECRET: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}
        ARM_SUBSCRIPTION_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}
        ARM_TENANT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}
      run: |
        terraform init \
          -backend-config="resource_group_name=${{ env.BACKEND_RESOURCE_GROUP_NAME }}" \
          -backend-config="storage_account_name=${{ env.BACKEND_STORAGE_ACCOUNT_NAME }}" \
          -backend-config="container_name=${{ env.BACKEND_CONTAINER_NAME }}" \
          -backend-config="key=${{ env.BACKEND_KEY }}"

    - name: Terraform Apply
      working-directory: ${{ env.WORKING_DIRECTORY }}
      env:
        ARM_CLIENT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
        ARM_CLIENT_SECRET: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}
        ARM_SUBSCRIPTION_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}
        ARM_TENANT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}
      run: terraform apply -auto-approve tfplan

    - name: Get Terraform Outputs
      id: tf-outputs
      working-directory: ${{ env.WORKING_DIRECTORY }}
      env:
        ARM_CLIENT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
        ARM_CLIENT_SECRET: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}
        ARM_SUBSCRIPTION_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}
        ARM_TENANT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}
      run: |
        echo "acr_login_server=$(terraform output -raw acr_login_server)" >> $GITHUB_OUTPUT
        echo "postgres_fqdn=$(terraform output -raw postgres_fqdn)" >> $GITHUB_OUTPUT
        echo "cluster_name=$(terraform output -raw cluster_name)" >> $GITHUB_OUTPUT

    - name: Save Outputs to Summary
      run: |
        echo "## ðŸŽ‰ Infrastructure Deployed Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Important Outputs:" >> $GITHUB_STEP_SUMMARY
        echo "- **ACR Login Server**: \`${{ steps.tf-outputs.outputs.acr_login_server }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **PostgreSQL FQDN**: \`${{ steps.tf-outputs.outputs.postgres_fqdn }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **AKS Cluster**: \`${{ steps.tf-outputs.outputs.cluster_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”„ Next Steps:" >> $GITHUB_STEP_SUMMARY
        echo "1. Update repository secrets with these values" >> $GITHUB_STEP_SUMMARY
        echo "2. Run the application deployment workflow" >> $GITHUB_STEP_SUMMARY
        echo "3. Configure kubectl: \`az aks get-credentials --resource-group rg-aks-crud-app --name ${{ steps.tf-outputs.outputs.cluster_name }}\`" >> $GITHUB_STEP_SUMMARY