# Test Docker builds locally
name: Test Docker Build

on:
  workflow_dispatch:
  push:
    paths:
      - 'backend/Dockerfile'
      - 'frontend/Dockerfile'

jobs:
  test-backend-build:
    name: Test Backend Docker Build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Test Backend Docker Build
      run: |
        echo "ğŸ”¨ Testing backend Docker build..."
        cd backend
        docker build -t test-backend:latest .
        echo "âœ… Backend Docker build successful!"
        
    - name: Test Backend Image
      run: |
        echo "ğŸ§ª Testing backend image..."
        docker run --rm -d --name test-backend -p 8080:8080 test-backend:latest
        sleep 10
        
        # Test if container is running
        if docker ps | grep test-backend; then
          echo "âœ… Backend container is running"
        else
          echo "âŒ Backend container failed to start"
          docker logs test-backend
          exit 1
        fi
        
        # Cleanup
        docker stop test-backend || true

  test-frontend-build:
    name: Test Frontend Docker Build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Test Frontend Docker Build
      run: |
        echo "ğŸ”¨ Testing frontend Docker build..."
        cd frontend
        docker build -t test-frontend:latest .
        echo "âœ… Frontend Docker build successful!"
        
    - name: Test Frontend Image
      run: |
        echo "ğŸ§ª Testing frontend image..."
        docker run --rm -d --name test-frontend -p 80:80 test-frontend:latest
        sleep 5
        
        # Test if container is running
        if docker ps | grep test-frontend; then
          echo "âœ… Frontend container is running"
        else
          echo "âŒ Frontend container failed to start"
          docker logs test-frontend
          exit 1
        fi
        
        # Test if nginx is serving content
        if curl -f http://localhost:80/ > /dev/null 2>&1; then
          echo "âœ… Frontend is serving content"
        else
          echo "âŒ Frontend is not responding"
          exit 1
        fi
        
        # Cleanup
        docker stop test-frontend || true